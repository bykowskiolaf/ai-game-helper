--- START FILE: .github/workflows/build_windows.yml ---
name: Release & Build

on:
  push:
    branches: ["main"]
    paths-ignore:
      - "CHANGELOG.md"
      - ".nyx-state.json"
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  # -----------------------------------------------------------------
  # JOB 1: Release (Nyx + GitHub App)
  # -----------------------------------------------------------------
  release:
    name: üöÄ Draft Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.nyx.outputs.version }}
      new_release: ${{ steps.nyx.outputs.newVersion }}
    steps:
      - name: Generate App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }} # Use App Token

      - name: Nyx publish
        id: nyx
        uses: mooltiverse/nyx@main
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        with:
          command: "publish"
          changelogPath: "CHANGELOG.md"
          preset: "extended"
          releaseLenient: "true"
          stateFile: ".nyx-state.json"
          summaryFile: ".nyx-summary.txt"
          verbosity: "INFO"

      - name: Commit Changelog
        if: steps.nyx.outputs.newVersion == 'true'
        run: |
          # Use the Bot Identity for the commit
          git config user.name "gh-actions-releaser[bot]"
          git config user.email "gh-actions-releaser[bot]@users.noreply.github.com"

          git add CHANGELOG.md .nyx-state.json

          if git diff-index --quiet HEAD; then
            echo "No changes. Skipping commit."
          else
            git commit -m "ci: update ${{ steps.nyx.outputs.version }} changelog and state [skip ci]"
            git push
          fi

  # -----------------------------------------------------------------
  # JOB 2: Build Windows EXE
  # -----------------------------------------------------------------
  build:
    name: üì¶ Build Windows EXE
    needs: release
    # Only run if Nyx actually created a new version
    if: needs.release.outputs.new_release == 'true'
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        run: uv python install 3.10

      - name: Install Dependencies
        run: |
          uv venv
          uv pip install mss customtkinter keyboard google-genai pillow pyinstaller python-dotenv

      - name: Build EXE
        run: |
          $Version = "${{ needs.release.outputs.version }}"

          # Create the version file so Python can read it
          echo $Version > src/version.txt

          # Tell PyInstaller to include this file inside the EXE (--add-data)
          # Format is "source;destination" for Windows
          uv run pyinstaller --noconsole --onefile --name "ESO-Helper-$Version" --add-data "src/version.txt;." src/main.py

      # -----------------------------------------------------------------
      # JOB 3: Upload Asset
      # -----------------------------------------------------------------
      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release.outputs.version }}
          files: dist/ESO-Helper-*.exe
        env:
          # We can use the default token here as the release already exists
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

--- END FILE: .github/workflows/build_windows.yml ---

--- START FILE: .gitignore ---
# Created by https://www.toptal.com/developers/gitignore/api/python
# Edit at https://www.toptal.com/developers/gitignore?templates=python

### Python ###
# Byte-compiled / optimized / DLL files
__pycache__/
*.py[cod]
*$py.class

# C extensions
*.so

# Distribution / packaging
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
share/python-wheels/
*.egg-info/
.installed.cfg
*.egg
MANIFEST

# PyInstaller
#  Usually these files are written by a python script from a template
#  before PyInstaller builds the exe, so as to inject date/other infos into it.
*.manifest
*.spec

# Installer logs
pip-log.txt
pip-delete-this-directory.txt

# Unit test / coverage reports
htmlcov/
.tox/
.nox/
.coverage
.coverage.*
.cache
nosetests.xml
coverage.xml
*.cover
*.py,cover
.hypothesis/
.pytest_cache/
cover/

# Translations
*.mo
*.pot

# Django stuff:
*.log
local_settings.py
db.sqlite3
db.sqlite3-journal

# Flask stuff:
instance/
.webassets-cache

# Scrapy stuff:
.scrapy

# Sphinx documentation
docs/_build/

# PyBuilder
.pybuilder/
target/

# Jupyter Notebook
.ipynb_checkpoints

# IPython
profile_default/
ipython_config.py

# pyenv
#   For a library or package, you might want to ignore these files since the code is
#   intended to run in multiple environments; otherwise, check them in:
# .python-version

# pipenv
#   According to pypa/pipenv#598, it is recommended to include Pipfile.lock in version control.
#   However, in case of collaboration, if having platform-specific dependencies or dependencies
#   having no cross-platform support, pipenv may install dependencies that don't work, or not
#   install all needed dependencies.
#Pipfile.lock

# poetry
#   Similar to Pipfile.lock, it is generally recommended to include poetry.lock in version control.
#   This is especially recommended for binary packages to ensure reproducibility, and is more
#   commonly ignored for libraries.
#   https://python-poetry.org/docs/basic-usage/#commit-your-poetrylock-file-to-version-control
#poetry.lock

# pdm
#   Similar to Pipfile.lock, it is generally recommended to include pdm.lock in version control.
#pdm.lock
#   pdm stores project-wide configurations in .pdm.toml, but it is recommended to not include it
#   in version control.
#   https://pdm.fming.dev/#use-with-ide
.pdm.toml

# PEP 582; used by e.g. github.com/David-OConnor/pyflow and github.com/pdm-project/pdm
__pypackages__/

# Celery stuff
celerybeat-schedule
celerybeat.pid

# SageMath parsed files
*.sage.py

# Environments
.env
.venv
env/
venv/
ENV/
env.bak/
venv.bak/

# Spyder project settings
.spyderproject
.spyproject

# Rope project settings
.ropeproject

# mkdocs documentation
/site

# mypy
.mypy_cache/
.dmypy.json
dmypy.json

# Pyre type checker
.pyre/

# pytype static type analyzer
.pytype/

# Cython debug symbols
cython_debug/

# PyCharm
#  JetBrains specific template is maintained in a separate JetBrains.gitignore that can
#  be found at https://github.com/github/gitignore/blob/main/Global/JetBrains.gitignore
#  and can be added to the global gitignore or merged into this file.  For a more nuclear
#  option (not recommended) you can uncomment the following to ignore the entire idea folder.
#.idea/

### Python Patch ###
# Poetry local configuration file - https://python-poetry.org/docs/configuration/#local-configuration
poetry.toml

# ruff
.ruff_cache/

# LSP config files
pyrightconfig.json

--- END FILE: .gitignore ---

--- START FILE: .nyx.json ---
{
    "preset": "extended",
    "changelog": {
        "path": "CHANGELOG.md",
        "append": "head"
    },
    "git": {
        "remotes": {
            "origin": {
                "user": "x-access-token",
                "password": "{{#environmentVariable}}GH_TOKEN{{/environmentVariable}}"
            }
        }
    },
    "services": {
        "github": {
            "type": "GITHUB",
            "options": {
                "AUTHENTICATION_TOKEN": "{{#environmentVariable}}GH_TOKEN{{/environmentVariable}}",
                "REPOSITORY_NAME": "ai-game-helper",
                "REPOSITORY_OWNER": "bykowskiolaf"
            }
        }
    },
    "releaseTypes": {
        "publicationServices": [
            "github"
        ],
        "enabled": [
            "mainline",
            "integration"
        ],
        "items": {
            "mainline": {
                "matchBranches": "^(master|main)$",
                "collapseVersions": false,
                "gitPush": "true",
                "gitTag": "true",
                "publish": "true",
                "assets": []
            },
            "integration": {
                "matchBranches": "^dev$",
                "collapseVersions": true,
                "collapsedVersionQualifier": "rc",
                "gitPush": "true",
                "gitTag": "true",
                "publish": "true",
                "assets": []
            }
        }
    }
}
--- END FILE: .nyx.json ---

--- START FILE: .python-version ---
3.11

--- END FILE: .python-version ---

--- START FILE: CHANGELOG.md ---
# Changelog

## 0.2.0 (2026-01-03)

### Fixed

* [6f810] fix: ensure newline at end of main.py file (Olaf Bykowski)

* [12edf] fix: include .nyx-state.json in changelog commit (Olaf Bykowski)

* [53ecc] fix: format YAML workflow for building Windows executable (Olaf Bykowski)

### Added

* [47583] feat: add initial CHANGELOG.md file (Olaf Bykowski)

* [3fa85] feat: enhance Nyx publish step with changelog and state file handling (Olaf Bykowski)

* [94064] feat: update GitHub Actions workflow and Nyx configuration for improved release process (Olaf Bykowski)

* [066a0] feat: enhance Windows build workflow and UI with draggable window and API key handling (Olaf Bykowski)

* [0344b] feat: initial poc test (Olaf Bykowski)


--- END FILE: CHANGELOG.md ---

--- START FILE: pyproject.toml ---
[project]
name = "ai-game-helper"
version = "0.1.0"
description = "Add your description here"
readme = "README.md"
requires-python = ">=3.11"
dependencies = [
    "customtkinter>=5.2.2",
    "google-genai>=1.56.0",
    "keyboard>=0.13.5",
    "mss>=10.1.0",
    "pillow>=12.1.0",
    "python-dotenv>=1.2.1",
]

--- END FILE: pyproject.toml ---

--- START FILE: src/ai.py ---
from google import genai
import config

def analyze_image(img):
    """Sends the image to Gemini and returns the advice text."""
    api_key = config.get_api_key()
    
    if not api_key:
        return "‚ùå Error: API Key is missing."

    try:
        client = genai.Client(api_key=api_key)
        
        prompt = """
        You are an expert Elder Scrolls Online (ESO) assistant.
        Look at this screenshot.
        
        STEP 1: CHECK CONTEXT
        - If this is NOT the game "Elder Scrolls Online" (e.g., a desktop, code editor, or browser), 
          STOP and strictly output: "‚ùå Not in game. Please open ESO."
        
        STEP 2: ANALYZE GAME
        - Only if it is ESO, identify the menu (Inventory, Skills, Death Recap, Open World).
        - Give one specific, high-impact tip based on the visible stats, items, or enemies.
        """
        
        response = client.models.generate_content(
            model="gemini-3-flash-preview",
            contents=[prompt, img]
        )
        return response.text

    except Exception as e:
        return f"‚ùå AI Error: {e}"
--- END FILE: src/ai.py ---

--- START FILE: src/capture.py ---
import platform
import subprocess
from PIL import Image, ImageGrab

def is_windows():
    return platform.system() == "Windows"

def capture_screen():
    """
    Captures the primary screen in-memory.
    - Windows: Uses 'mss' (extremely fast for games).
    - Mac: Uses 'ImageGrab' (native, stable, no files).
    """
    if is_windows():
        # Windows: MSS is optimized for high-FPS capturing
        import mss
        with mss.mss() as sct:
            monitor = sct.monitors[1]
            sct_img = sct.grab(monitor)
            return Image.frombytes("RGB", sct_img.size, sct_img.bgra, "raw", "BGRX")
    else:
        return ImageGrab.grab()
--- END FILE: src/capture.py ---

--- START FILE: src/config.py ---
import os
from dotenv import load_dotenv

load_dotenv()

TRIGGER_KEY = "f11"
EXIT_KEY = "f12"

def get_api_key():
    return os.getenv("GOOGLE_API_KEY")

def save_api_key(key):
    with open(".env", "w") as f:
        f.write(f"GOOGLE_API_KEY={key}")
    os.environ["GOOGLE_API_KEY"] = key
--- END FILE: src/config.py ---

--- START FILE: src/main.py ---
from ui import GameHelperApp

if __name__ == "__main__":
    app = GameHelperApp()
    app.mainloop()

--- END FILE: src/main.py ---

--- START FILE: src/ui.py ---
import customtkinter as ctk
import tkinter as tk
import threading
import config
import capture
import ai
import updater

class DraggableWindow(ctk.CTk):
    """A frameless window that can be dragged"""
    def __init__(self):
        super().__init__()
        self.overrideredirect(True) # Removes Title Bar & Borders
        self._offsetx = 0
        self._offsety = 0
        self.bind('<Button-1>', self.clickwin)
        self.bind('<B1-Motion>', self.dragwin)

    def clickwin(self, event):
        self._offsetx = event.x
        self._offsety = event.y

    def dragwin(self, event):
        x = self.winfo_pointerx() - self._offsetx
        y = self.winfo_pointery() - self._offsety
        self.geometry(f'+{x}+{y}')

class GameHelperApp(DraggableWindow):
    def __init__(self):
        super().__init__()
        
        # Window Setup
        self.geometry("400x150+50+50") 
        self.configure(fg_color="#1a1a1a") # Dark background
        
        # --- FORCE ON TOP SETTINGS ---
        self.attributes("-topmost", True)
        self.attributes("-alpha", 0.80) 
        self.lift() # Lift to top immediately
        
        # Start the "Watchdog" to keep it on top
        self.enforce_topmost()

        # Check API Key
        if not config.get_api_key():
            self.show_login()
        else:
            self.show_hud()

        self.update_available = False
        self.update_url = None
        threading.Thread(target=self.bg_update_check, daemon=True).start()

    def enforce_topmost(self):
        """Forces the window to the top layer every 2 seconds"""
        self.lift()
        self.attributes("-topmost", True)
        self.after(2000, self.enforce_topmost)

    def show_login(self):
        self.overrideredirect(False) 
        ctk.CTkLabel(self, text="üîë Enter API Key & Press Enter", font=("Segoe UI", 14, "bold")).pack(pady=20)
        self.entry = ctk.CTkEntry(self, width=300)
        self.entry.pack()
        self.entry.bind("<Return>", self.save_key)

    def save_key(self, event):
        key = self.entry.get().strip()
        if len(key) > 5:
            config.save_api_key(key)
            for widget in self.winfo_children(): widget.destroy()
            self.show_hud()

    def show_hud(self):
        self.overrideredirect(True) 
        
        # Text Area (HUD Style)
        self.text_area = tk.Text(
            self, 
            bg="#1a1a1a", 
            fg="#e0e0e0", 
            font=("Consolas", 11), 
            wrap="word", 
            bd=0, 
            highlightthickness=0,
            padx=10, pady=10
        )
        self.text_area.pack(fill="both", expand=True)
        
        # Markdown Styles
        self.text_area.tag_config("bold", font=("Consolas", 11, "bold"), foreground="#4cc9f0")
        self.text_area.tag_config("header", font=("Consolas", 13, "bold"), foreground="#f72585")
        self.text_area.tag_config("bullet", foreground="#ffd60a")

        self.render_markdown(f"READY\n[F11] Analyze\n[F12] Quit")

        # Bindings
        self.text_area.bind("<Button-3>", lambda e: self.render_markdown("")) # Right-click to clear
        self.text_area.bind('<Button-1>', self.clickwin)
        self.text_area.bind('<B1-Motion>', self.dragwin)

        if capture.is_windows():
            self.start_hotkeys()

    def render_markdown(self, raw_text):
        self.text_area.config(state="normal")
        self.text_area.delete("1.0", "end")
        
        lines = raw_text.split("\n")
        for line in lines:
            if line.startswith("#"):
                self.text_area.insert("end", line.replace("#", "").strip() + "\n", "header")
            elif line.strip().startswith("* ") or line.strip().startswith("- "):
                self.text_area.insert("end", " ‚Ä¢ " + line.strip()[2:] + "\n", "bullet")
            else:
                parts = line.split("**")
                for i, part in enumerate(parts):
                    tag = "bold" if i % 2 == 1 else "normal"
                    self.text_area.insert("end", part, tag)
                self.text_area.insert("end", "\n")

        self.text_area.config(state="disabled") 
        
        # Auto-Resize Window Height
        num_lines = int(self.text_area.index('end-1c').split('.')[0])
        new_height = min(600, max(100, num_lines * 20 + 30))
        self.geometry(f"400x{new_height}")

    def run_analysis_thread(self):
        t = threading.Thread(target=self.run_logic, daemon=True)
        t.start()

    def run_logic(self):
        self.render_markdown("... üëÄ Looking ...")
        try:
            img = capture.capture_screen()
            img.thumbnail((1024, 1024))
            self.render_markdown("... üß† Thinking ...")
            result = ai.analyze_image(img)
            self.render_markdown(result)
        except Exception as e:
            self.render_markdown(f"Error: {e}")

    def start_hotkeys(self):
        try:
            import keyboard
            def listen():
                keyboard.add_hotkey(config.TRIGGER_KEY, self.run_analysis_thread)
                keyboard.add_hotkey(config.EXIT_KEY, self.quit)
                keyboard.wait()
            threading.Thread(target=listen, daemon=True).start()
        except ImportError:
            pass

    def bg_update_check(self):
        """Runs silently on startup"""
        available, url, version = updater.check_for_updates()
        if available:
            self.update_available = True
            self.update_url = url
            self.new_version = version
            # If HUD is already open, show the alert
            if hasattr(self, 'text_area'):
                self.show_update_alert()

    def show_update_alert(self):
        """Injects a link into the Markdown text"""
        msg = f"\n\nüö® UPDATE AVAILABLE: {self.new_version}\n[Right-Click to Update Now]"
        # We append this to the text area
        self.render_markdown(self.text_area.get("1.0", "end") + msg)
        # Bind Right-Click to Trigger Update (Override the 'Clear' binding if update exists)
        self.text_area.bind("<Button-3>", self.trigger_update)

    def trigger_update(self, event):
        if self.update_available:
            self.render_markdown(f"‚¨á Downloading {self.new_version}...\nPlease wait, app will restart.")
            # Run download in thread to avoid freezing UI
            threading.Thread(target=updater.update_app, args=(self.update_url,), daemon=True).start()
        else:
            # Standard Clear behavior
            self.render_markdown("")
--- END FILE: src/ui.py ---
